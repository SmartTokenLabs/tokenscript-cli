import{r as t,h as i,g as s}from"./p-f0f1815c.js";import{V as e}from"./p-1a921d6b.js";import{b as n,C as o}from"./p-ea01a02d.js";import"./p-4a1bebfd.js";import"./p-0a353f40.js";class a{constructor(t,i){this.negotiator=t;this.tokenScript=i;this.updateFromEngine=false}async getTokens(t){this.updateFromEngine=true;return new Promise(((i,s)=>{const e={};const o=[];const a=[];for(let i of t){if(i.tokenType==="erc20"){i.name=i.id;o.push(i);continue}const t=(i.blockChain+"-"+i.chainId+"-"+i.collectionId).toLowerCase();if(!n[i.chainId]){console.warn("Token discovery not supported for chain ID "+i.chainId);continue}e[t]=i;a.push({onChain:true,collectionID:t,contract:i.collectionId,chain:n[i.chainId]})}if(!a.length){i(o);return}this.negotiator.on("tokens-selected",(t=>{var s;console.log("Tokens discovered: ");console.log(t.selectedTokens);for(let i in t.selectedTokens){if(!e[i])continue;const n=e[i];const a=t.selectedTokens[i].tokens;const l=[];for(let t of a){l.push({collectionDetails:n,tokenId:t.tokenId,name:t.title,description:t.description,image:t.image,data:t})}n.symbol=(s=a[0])===null||s===void 0?void 0:s.symbol;n.nftDetails=l;n.balance=l.length;o.push(n)}if(this.updateFromEngine){this.updateFromEngine=false;i(o)}else{this.tokenScript.setTokenMetadata(o)}}));this.negotiator.negotiate(a)}))}}const l=".attribute-table{position:absolute;bottom:20px;background:#fff;text-align:left;border:#000 solid 1px}.attribute-table td,.attribute-table th{padding:8px}.close-btn{position:absolute;right:0;top:0;margin:20px;font-size:22px;font-weight:bold;width:35px;height:35px}.card-container{position:relative;max-width:500px;margin:50px auto;border-radius:4px}.view-container{width:100%;padding:20px;position:absolute;top:0;min-height:100%;background:#1a1a1ae0;z-index:100}.view-loader{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background-color:rgba(131,131,131,0.67)}.tokenscript-frame{background:#fff;width:100%;height:650px;border:1px solid black;border-radius:4px;box-sizing:border-box}.action-bar{height:35px}.action-btn{width:100%;height:100%}.toast{position:absolute;z-index:200}";const c=class{constructor(i){t(this,i);this.uuid=Date.now();this.negotiator=new o({type:"active",issuers:[],uiOptions:{containerElement:"#tn-"+this.uuid,theme:"light",openingHeading:"Connect your wallet to load this TokenScripts tokens."}});this.walletChangeListener=async t=>{if(t.detail.id===this.uuid)return;console.log("TN IPC "+this.uuid+": Processing tn-wallet-change");const i=await this.negotiator.getWalletProvider();this.currentProvider=t.detail.provider;if(!t.detail.provider){console.log("TN IPC: Disconnect");await this.negotiator.disconnectWallet();this.negotiator.getUi().updateUI("wallet");return}console.log("TN IPC: Connect");await i.loadConnections();if(this.negotiator.getUi())this.negotiator.getUi().updateUI("main")};this.app=undefined;this.tabId=undefined;this.tokenScript=undefined}async loadTs(){if(!this.viewBinding){this.viewBinding=new e(this.host,this.showToast.bind(this))}this.viewBinding.setTokenScript(this.tokenScript);this.tokenScript.setViewBinding(this.viewBinding)}componentWillLoad(){if(this.tokenScript){this.discoveryAdapter=new a(this.negotiator,this.tokenScript);this.tokenScript.setTokenDiscoveryAdapter(this.discoveryAdapter)}}connectedCallback(){this.setupTnInstanceGlue()}disconnectedCallback(){window.removeEventListener("tn-wallet-change",this.walletChangeListener);this.negotiator.on("connected-wallet",(()=>{}));this.negotiator.on("tokens-selected",(()=>{}));this.negotiator=null;this.discoveryAdapter=null}async setupTnInstanceGlue(){var t;this.currentProvider=(t=(await this.negotiator.getWalletProvider()).getConnectedWalletData()[0])===null||t===void 0?void 0:t.providerType;this.negotiator.on("connected-wallet",(t=>{var i;const s=(i=t===null||t===void 0?void 0:t.data)===null||i===void 0?void 0:i.providerType;if(s==this.currentProvider)return;this.currentProvider=s;this.dispatchWalletChangedEvent(s)}));window.addEventListener("tn-wallet-change",this.walletChangeListener)}dispatchWalletChangedEvent(t){console.log("TN IPC "+this.uuid+": Sending TN event, disconnect: ",t);const i=new CustomEvent("tn-wallet-change",{detail:{id:this.uuid,provider:t}});window.dispatchEvent(i)}componentWillUpdate(){this.discoveryAdapter=new a(this.negotiator,this.tokenScript);this.tokenScript.setTokenDiscoveryAdapter(this.discoveryAdapter)}componentDidLoad(){if(this.tokenScript)this.loadTs();this.host.querySelector(".toast").shadowRoot.querySelector(":host > div").setAttribute("style","margin-top: 100px;")}showToast(t,i,s){const e=this.host.querySelector(".toast");e.Toast({title:i,description:s,timeOut:3e4,position:"top-right",type:t})}render(){return i("div",null,i("tokens-grid",{tokenScript:this.tokenScript,showToast:this.showToast.bind(this)}),i("div",{class:"view-container",style:{display:"none"}},i("button",{class:"close-btn",onClick:()=>{document.location.hash="#";this.tokenScript.getViewController().unloadTokenCard()}},"X"),i("div",{class:"card-container"},i("div",{class:"view-loader",style:{display:"none"}},i("loading-spinner",null)),i("iframe",{class:"tokenscript-frame",sandbox:"allow-scripts allow-modals allow-forms"}),i("div",{class:"action-bar",style:{display:"none"}},i("button",{class:"action-btn"}))),i("table",{class:"attribute-table"})),i("security-status",{tokenScript:this.tokenScript}),i("div",{id:"tn-"+this.uuid,class:"overlay-tn"}),i("cb-toast",{class:"toast"}))}get host(){return s(this)}static get watchers(){return{tokenScript:["loadTs"]}}};c.style=l;export{c as viewer_tab};
//# sourceMappingURL=p-5d8904b4.entry.js.map